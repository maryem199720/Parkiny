<div class="flex min-h-screen bg-background font-poppins">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-lg p-4">
    <div class="flex items-center gap-2 mb-6">
      <i class="ri-user-line text-2xl text-primary"></i>
      <h2 class="text-xl font-bold text-text">{{ user().firstName }} {{ user().lastName }}</h2>
    </div>
    <nav class="space-y-2">
      <button
        (click)="navigateTo('/home')"
        class="w-full flex items-center gap-2 p-2 text-text hover:bg-gray-100 rounded-lg"
      >
        <i class="ri-home-line"></i> Accueil
      </button>
      <button
        class="w-full flex items-center gap-2 p-2 bg-primary text-white rounded-lg"
      >
        <i class="ri-user-line"></i> Profil
      </button>
      <button
        (click)="navigateTo('/notification-settings')"
        class="w-full flex items-center gap-2 p-2 text-text hover:bg-gray-100 rounded-lg"
      >
        <i class="ri-notification-line"></i> Notifications
      </button>
      <button
        (click)="navigateTo('/privacy-settings')"
        class="w-full flex items-center gap-2 p-2 text-text hover:bg-gray-100 rounded-lg"
      >
        <i class="ri-shield-line"></i> Confidentialité
      </button>
      <button
        (click)="navigateTo('/language-preferences')"
        class="w-full flex items-center gap-2 p-2 text-text hover:bg-gray-100 rounded-lg"
      >
        <i class="ri-global-line"></i> Langue
      </button>
      <button
        (click)="navigateTo('/help-support')"
        class="w-full flex items-center gap-2 p-2 text-text hover:bg-gray-100 rounded-lg"
      >
        <i class="ri-question-line"></i> Aide
      </button>
      <button
        (click)="logout()"
        class="w-full flex items-center gap-2 p-2 text-error hover:bg-error hover:bg-opacity-10 rounded-lg"
      >
        <i class="ri-logout-box-line"></i> Déconnexion
      </button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold text-text">Mon Profil</h1>
      <button (click)="logout()" class="text-primary hover:text-primary-dark">
        <i class="ri-logout-box-line ri-lg"></i>
      </button>
    </header>

    <!-- Loading State -->
    @if (isLoading()) {
      <div class="flex flex-col items-center justify-center h-64">
        <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-2 text-text">Chargement</p>
      </div>
    } @else {
      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="mb-4 p-4 bg-error bg-opacity-10 border-l-4 border-error rounded-lg flex items-center">
          <i class="ri-error-warning-line text-error mr-2"></i>
          <p class="text-error">{{ errorMessage() }}</p>
        </div>
      }

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Profile and Actions -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Profile Card -->
          <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex flex-col items-center">
              <div class="w-20 h-20 rounded-full bg-primary-light flex items-center justify-center text-primary text-2xl font-bold">
                {{ user().firstName[0] || '' }}{{ user().lastName[0] || '' }}
              </div>
              <h2 class="mt-4 text-2xl font-bold text-text">{{ user().firstName }} {{ user().lastName }}</h2>
              <p class="text-subtitle text-sm">{{ user().email }}</p>
              <p class="text-subtitle text-sm">Téléphone: {{ user().phone || 'Non défini' }}</p>
              <button
                (click)="openEditProfileDialog()"
                class="mt-4 bg-primary text-gray-900 px-4 py-2 rounded-button flex items-center gap-2 hover:bg-opacity-90 transition-colors"
              >
                <i class="ri-edit-line"></i> Modifier mes informations
              </button>
            </div>
          </div>

          <!-- Password Change -->
          <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex items-center gap-4 cursor-pointer" (click)="openPasswordChangeDialog()">
              <div class="p-2 bg-primary-light rounded-lg">
                <i class="ri-lock-line text-primary"></i>
              </div>
              <div>
                <h3 class="font-medium text-text">Changer le Mot de Passe</h3>
                <p class="text-subtitle text-sm">Mettre à jour la sécurité du compte</p>
              </div>
              <i class="ri-chevron-right text-subtitle ml-auto"></i>
            </div>
          </div>

          <!-- Subscription -->
          <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex items-center justify-between cursor-pointer" (click)="isSubscriptionExpanded.set(!isSubscriptionExpanded())">
              <div class="flex items-center gap-4">
                <div class="p-2 bg-accent-light rounded-lg">
                  <i class="ri-subscription-line text-secondary"></i>
                </div>
                <h3 class="text-lg font-semibold text-text">Mon Abonnement</h3>
              </div>
              <i class="ri-{{ isSubscriptionExpanded() ? 'expand-less' : 'expand-more' }} text-subtitle"></i>
            </div>
            @if (isSubscriptionExpanded()) {
              <div class="mt-4">
                <div class="p-4 bg-gray-100 rounded-lg">
                  <h4 class="font-medium text-text">Plan Premium</h4>
                  <p class="text-subtitle text-sm">Valide jusqu'au {{ user().subscription.subscriptionEndDate }}</p>
                  <button
                    (click)="navigateTo('/subscription')"
                    class="mt-2 flex items-center gap-2 text-primary hover:text-primary-dark"
                  >
                    Gérer <i class="ri-chevron-right"></i>
                  </button>
                </div>
                <button
                  (click)="navigateTo('/subscription-history')"
                  class="mt-4 flex items-center gap-2 text-subtitle hover:text-subtitle-dark"
                >
                  <i class="ri-history-line"></i> Voir l'historique des abonnements
                </button>
              </div>
            }
          </div>
        </div>

        <!-- Reservations and Vehicles -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Reservations -->
          <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="p-2 bg-success bg-opacity-20 rounded-lg">
                  <i class="ri-event-line text-success"></i>
                </div>
                <h3 class="text-lg font-semibold text-text">Mes Réservations</h3>
              </div>
            </div>
            <div class="flex justify-center gap-4 mb-4">
              <button
                (click)="toggleReservationsTab(true)"
                class="px-6 py-2 rounded-lg font-medium transition-colors"
                [class.bg-primary]="isActiveReservations()"
                [class.text-white]="isActiveReservations()"
                [class.bg-gray]="!isActiveReservations()"
                [class.text-text]="!isActiveReservations()"
              >
                Actives
              </button>
              <button
                (click)="toggleReservationsTab(false)"
                class="px-6 py-2 rounded-lg font-medium transition-colors"
                [class.bg-primary]="!isActiveReservations()"
                [class.text-white]="!isActiveReservations()"
                [class.bg-gray]="isActiveReservations()"
                [class.text-text]="isActiveReservations()"
              >
                Expirées
              </button>
            </div>
            <div class="max-h-96 overflow-y-auto">
              @if ((isActiveReservations() ? activeReservations() : expiredReservations()).length === 0) {
                <div class="flex flex-col items-center py-4">
                  <i class="ri-event-busy-line text-4xl text-subtitle"></i>
                  <p class="text-subtitle mt-2">{{ isActiveReservations() ? 'Aucune réservation active' : 'Aucune réservation expirée' }}</p>
                </div>
              } @else {
                @for (reservation of (isActiveReservations() ? activeReservations() : expiredReservations()); track reservation.parkingSpotId) {
                  <div class="flex items-center gap-4 p-4 bg-white rounded-lg shadow mb-2">
                    <div class="p-2 bg-primary-light rounded-lg">
                      <i class="ri-parking-box-line text-primary"></i>
                    </div>
                    <div class="flex-1">
                      <h4 class="font-medium text-text">Place {{ reservation.parkingSpotId }}</h4>
                      <p class="text-subtitle text-sm">Début: {{ reservation.startTime | date: 'dd/MM/yyyy HH:mm' }}</p>
                      <p class="text-subtitle text-sm">Fin: {{ reservation.endTime | date: 'dd/MM/yyyy HH:mm' }}</p>
                      <p class="text-subtitle text-sm">Coût: {{ reservation.totalCost }} DT</p>
                    </div>
                    <i class="ri-{{ reservation.status === 'PENDING' ? 'time-line' : 'check-circle-line' }} text-{{ reservation.status === 'PENDING' ? 'secondary' : 'success' }}"></i>
                  </div>
                }
              }
            </div>
          </div>

          <!-- Vehicles -->
          <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex items-center justify-between cursor-pointer" (click)="isVehiclesExpanded.set(!isVehiclesExpanded())">
              <div class="flex items-center gap-4">
                <div class="p-2 bg-primary-light rounded-lg">
                  <i class="ri-car-line text-primary"></i>
                </div>
                <h3 class="text-lg font-semibold text-text">Mes Véhicules</h3>
              </div>
              <i class="ri-{{ isVehiclesExpanded() ? 'expand-less' : 'expand-more' }} text-subtitle"></i>
            </div>
            @if (isVehiclesExpanded()) {
              <div class="mt-4">
                @if (user().vehicles.length > 0) {
                  @for (vehicle of user().vehicles; track vehicle.matricule) {
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg mb-2 cursor-pointer" (click)="navigateTo('/vehicle-details/' + vehicle.matricule)">
                      <div class="p-2 bg-primary-light rounded-lg">
                        <i class="ri-car-line text-primary"></i>
                      </div>
                      <div>
                        <h4 class="font-medium text-text">{{ vehicle.brand }} {{ vehicle.model }}</h4>
                        <p class="text-subtitle text-sm">Matricule: {{ vehicle.matricule }} • Couleur: {{ vehicle.color }}</p>
                      </div>
                      <i class="ri-chevron-right text-subtitle ml-auto"></i>
                    </div>
                  }
                } @else {
                  <div class="flex flex-col items-center py-4">
                    <i class="ri-car-line text-4xl text-subtitle"></i>
                    <p class="text-subtitle mt-2">Aucun véhicule</p>
                  </div>
                }
                <button
                  (click)="openAddVehicleDialog()"
                  class="mt-4 flex items-center gap-2 text-primary hover:text-primary-dark"
                >
                  <i class="ri-add-line"></i> Ajouter un Véhicule
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </main>
</div>