<div class="reservation-container">
  <div class="reservation-header">
    <h2><mat-icon>local_parking</mat-icon> Réservation de parking</h2>
    <p>Garantissez votre place en quelques étapes simples</p>
  </div>

  <!-- Stepper -->
  <div class="stepper">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <div class="step-number">{{ currentStep > 1 ? '✓' : '1' }}</div>
      <div class="step-label">Choix de la place</div>
      <div class="step-line"></div>
    </div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <div class="step-number">{{ currentStep > 2 ? '✓' : '2' }}</div>
      <div class="step-label">Informations</div>
      <div class="step-line"></div>
    </div>
    <div class="step" [class.active]="currentStep === 3">
      <div class="step-number">3</div>
      <div class="step-label">Confirmation</div>
    </div>
  </div>

  <!-- Step 1: Place Selection -->
  <div *ngIf="currentStep === 1" class="step-content">
    <div class="map-section">
      <div class="map-header">
        <h3><mat-icon>map</mat-icon> Plan du parking</h3>
        <div class="legend">
          <span class="legend-item"><span class="color-box standard"></span> Standard (5 TND/h)</span>
          <span class="legend-item"><span class="color-box premium"></span> Premium (8 TND/h)</span>
          <span class="legend-item"><span class="color-box reserved"></span> Réservé</span>
        </div>
      </div>
      
      <div class="parking-lot">
        <div *ngFor="let place of availablePlaces" 
             class="parking-space"
             [class.selected]="place.selected"
             [class.reserved]="place.reserved"
             [class.standard]="!place.reserved && place.type === 'standard'"
             [class.premium]="!place.reserved && place.type === 'premium'"
             (click)="selectPlace(place)"
             [matTooltip]="getPlaceTooltip(place)">
          
          <div class="space-number">{{ place.name }}</div>
          <div class="space-price" *ngIf="!place.reserved">
            {{ place.price }} TND/h
          </div>
          
          <mat-icon class="reserved-icon" *ngIf="place.reserved">lock</mat-icon>
        </div>
      </div>
      
      <div class="place-details" *ngIf="selectedPlace">
        <h4>Détails de la place sélectionnée</h4>
        <div class="details-grid">
          <div><mat-icon>place</mat-icon> <span>Place: {{ selectedPlace.name }}</span></div>
          <div><mat-icon>category</mat-icon> <span>Type: {{ getPlaceTypeLabel(selectedPlace.type) }}</span></div>
          <div>
            <mat-icon>attach_money</mat-icon> 
            <span>Tarif: {{ selectedPlace.price }} TND/h</span>
          </div>
          <div *ngIf="selectedPlace.features.length">
            <mat-icon>star</mat-icon> 
            <span>Avantages: {{ selectedPlace.features.join(', ') }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button color="warn" (click)="reset()">
        <mat-icon>refresh</mat-icon> Réinitialiser
      </button>
      <button mat-raised-button color="primary" (click)="nextStep()" [disabled]="!placeSelected">
        Suivant <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </div>

  <!-- Step 2: Reservation Details -->
  <div *ngIf="currentStep === 2" class="step-content">
    <div class="form-status" [ngClass]="{'valid': reservationForm.valid, 'invalid': reservationForm.invalid}">
      État du formulaire : {{ reservationForm.valid ? 'Valide' : 'Invalide' }}
    </div>
    <form [formGroup]="reservationForm" class="form-section">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Date de réservation</mat-label>
          <input matInput formControlName="date" [matDatepicker]="picker" [min]="getToday()">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-icon matPrefix>calendar_today</mat-icon>
          <mat-hint>JJ/MM/AAAA</mat-hint>
          <mat-error *ngIf="reservationForm.get('date')?.hasError('required') && reservationForm.get('date')?.touched">
            La date est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Heure de début</mat-label>
          <input matInput formControlName="heureDebut" type="time">
          <mat-icon matPrefix>access_time</mat-icon>
          <mat-error *ngIf="reservationForm.get('heureDebut')?.hasError('required') && reservationForm.get('heureDebut')?.touched">
            L'heure de début est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Heure de fin</mat-label>
          <input matInput formControlName="heureFin" type="time">
          <mat-icon matPrefix>access_time</mat-icon>
          <mat-error *ngIf="reservationForm.get('heureFin')?.hasError('required') && reservationForm.get('heureFin')?.touched">
            L'heure de fin est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Véhicule (Immatriculation)</mat-label>
          <input matInput formControlName="vehicle" placeholder="ex: 123TU1234">
          <mat-icon matPrefix>directions_car</mat-icon>
          <mat-error *ngIf="reservationForm.get('vehicle')?.hasError('required') && reservationForm.get('vehicle')?.touched">
            L'immatriculation est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Type de véhicule</mat-label>
          <mat-select formControlName="vehicleType">
            <mat-option *ngFor="let type of vehicleTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
          <mat-error *ngIf="reservationForm.get('vehicleType')?.hasError('required') && reservationForm.get('vehicleType')?.touched">
            Le type de véhicule est requis
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" type="email">
          <mat-icon matPrefix>email</mat-icon>
          <mat-hint>Pour recevoir la confirmation</mat-hint>
          <mat-error *ngIf="reservationForm.get('email')?.hasError('required') && reservationForm.get('email')?.touched">
            L'email est requis
          </mat-error>
          <mat-error *ngIf="reservationForm.get('email')?.hasError('email') && reservationForm.get('email')?.touched">
            Format d'email invalide
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Téléphone</mat-label>
          <input matInput formControlName="phone" type="tel" placeholder="12345678">
          <mat-icon matPrefix>phone</mat-icon>
          <mat-hint>8 chiffres</mat-hint>
          <mat-error *ngIf="reservationForm.get('phone')?.hasError('required') && reservationForm.get('phone')?.touched">
            Le téléphone est requis
          </mat-error>
          <mat-error *ngIf="reservationForm.get('phone')?.hasError('pattern') && reservationForm.get('phone')?.touched">
            Doit être 8 chiffres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Méthode de paiement</mat-label>
          <mat-select formControlName="paymentMethod">
            <mat-option *ngFor="let method of paymentMethods" [value]="method">
              {{ method }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>payment</mat-icon>
          <mat-error *ngIf="reservationForm.get('paymentMethod')?.hasError('required') && reservationForm.get('paymentMethod')?.touched">
            La méthode de paiement est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Demande spéciale</mat-label>
          <textarea matInput formControlName="specialRequest" rows="3"></textarea>
          <mat-icon matPrefix>note</mat-icon>
          <mat-hint>Accès handicapé, besoin particulier...</mat-hint>
        </mat-form-field>
      </div>

      <div class="summary-card">
        <h4><mat-icon>receipt</mat-icon> Récapitulatif</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <mat-icon>place</mat-icon>
            <span>Place:</span>
            <strong>{{ selectedPlace?.name || 'Aucune' }}</strong>
          </div>
          <div class="summary-item">
            <mat-icon>category</mat-icon>
            <span>Type:</span>
            <strong>{{ getPlaceTypeLabel(selectedPlace?.type) }}</strong>
          </div>
          <div class="summary-item">
            <mat-icon>schedule</mat-icon>
            <span>Durée:</span>
            <strong>{{ calculateDuration() }}</strong>
          </div>
          <div class="summary-item">
            <mat-icon>attach_money</mat-icon>
            <span>Tarif horaire:</span>
            <strong>{{ selectedPlace?.price || '0' }} TND/h</strong>
          </div>
          <div class="summary-item total">
            <mat-icon>payments</mat-icon>
            <span>Total à payer:</span>
            <strong>{{ calculatedMontant }} TND</strong>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button mat-stroked-button type="button" (click)="prevStep()">
          <mat-icon>arrow_back</mat-icon> Retour
        </button>
        <button mat-stroked-button type="button" (click)="debugForm()">
          <mat-icon>bug_report</mat-icon> Déboguer le formulaire
        </button>
        <button mat-raised-button color="primary" type="button" (click)="nextStep()" 
                [disabled]="reservationForm.invalid">
          Suivant <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </form>
  </div>

  <!-- Step 3: Confirmation -->
  <div *ngIf="currentStep === 3" class="step-content confirmation">
    <div *ngIf="!reservationSuccess; else successTemplate" class="confirmation-card">
      <mat-icon class="confirmation-icon">assignment</mat-icon>
      <h3>Vérifiez votre réservation</h3>
      
      <div class="confirmation-details">
        <div class="detail-item">
          <mat-icon>confirmation_number</mat-icon>
          <span>Référence: <strong>En attente...</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>place</mat-icon>
          <span>Place: <strong>{{ selectedPlace?.name }}</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>date_range</mat-icon>
          <span>Date: <strong>{{ reservationForm.get('date')?.value | date:'dd/MM/yyyy' }}</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>schedule</mat-icon>
          <span>Heure: <strong>{{ reservationForm.get('heureDebut')?.value }} - {{ reservationForm.get('heureFin')?.value }}</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>directions_car</mat-icon>
          <span>Véhicule: <strong>{{ reservationForm.get('vehicle')?.value }} ({{ reservationForm.get('vehicleType')?.value }})</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>contact_mail</mat-icon>
          <span>Contact: <strong>{{ reservationForm.get('email')?.value }} / {{ reservationForm.get('phone')?.value }}</strong></span>
        </div>
        <div class="detail-item">
          <mat-icon>payment</mat-icon>
          <span>Paiement: <strong>{{ reservationForm.get('paymentMethod')?.value }}</strong></span>
        </div>
        <div *ngIf="reservationForm.get('specialRequest')?.value" class="detail-item">
          <mat-icon>note</mat-icon>
          <span>Demande spéciale: <strong>{{ reservationForm.get('specialRequest')?.value }}</strong></span>
        </div>
        <div class="detail-item total">
          <mat-icon>payments</mat-icon>
          <span>Total à payer:</span>
          <strong>{{ calculatedMontant }} TND</strong>
        </div>
      </div>

      <div class="payment-section">
        <h4><mat-icon>payment</mat-icon> Procéder au paiement</h4>
        <p>Veuillez initier le paiement pour confirmer votre réservation.</p>
        <button mat-raised-button color="accent" (click)="initiatePayment()" [disabled]="isLoading || paymentInitiated">
          <span *ngIf="!isLoading">
            <mat-icon>credit_card</mat-icon> Payer {{ calculatedMontant }} TND
          </span>
          <span *ngIf="isLoading">
            <mat-spinner diameter="20"></mat-spinner> Traitement...
          </span>
        </button>
        <a *ngIf="paymentUrl" [href]="paymentUrl" target="_blank" class="payment-link">
          <mat-icon>open_in_new</mat-icon> Ouvrir la page de paiement
        </a>
      </div>

      <div class="action-buttons">
        <button mat-stroked-button (click)="prevStep()">
          <mat-icon>arrow_back</mat-icon> Modifier
        </button>
        <button mat-raised-button color="primary" (click)="submitReservation()" 
                [disabled]="isLoading || !paymentInitiated">
          <span *ngIf="!isLoading">
            <mat-icon>check</mat-icon> Confirmer la réservation
          </span>
          <span *ngIf="isLoading">
            <mat-spinner diameter="20"></mat-spinner> Traitement...
          </span>
        </button>
      </div>
    </div>

    <ng-template #successTemplate>
      <div class="success-card">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h3>Réservation confirmée!</h3>
        <p class="success-message">
          Votre place de parking a été réservée avec succès. Un email de confirmation vous a été envoyé.
        </p>
        
        <div class="reservation-number">
          <mat-icon>confirmation_number</mat-icon>
          <span>N° de réservation: <strong>RES-{{ generateRandomId() }}</strong></span>
        </div>
        
        <div class="qr-code-placeholder">
          <mat-icon>qr_code</mat-icon>
          <p>Présentez ce QR code à l'arrivée</p>
        </div>
        
        <button mat-raised-button color="primary" (click)="reset()" class="new-reservation-btn">
          <mat-icon>add</mat-icon> Nouvelle réservation
        </button>
      </div>
    </ng-template>
  </div>
</div>