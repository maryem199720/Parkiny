<!-- subscription.component.html -->
<div class="bg-gray-50 min-h-screen">
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-dark mb-4 font-display">
          Souscrivez à <span class="text-primary-purple">Parki</span>
        </h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">
          Choisissez un plan d'abonnement adapté à vos besoins en quelques étapes simples.
        </p>
      </div>

      <!-- Subscription Banner -->
      <div *ngIf="hasActiveSubscription; else noSubscription" class="subscription-banner mb-8">
        <div class="flex items-center">
          <i class="ri-verified-badge-line text-primary-purple text-2xl mr-3"></i>
          <div>
            <h3 class="font-semibold text-dark">Abonnement Actif (ID: {{ activeSubscription?.id }})</h3>
            <p class="text-sm text-gray-600">
              Valide jusqu'au {{ activeSubscription?.endDate | date:'MM/dd/yyyy' }} | {{ activeSubscription?.remainingPlaces }} places restantes
            </p>
          </div>
        </div>
      
      </div>
      <ng-template #noSubscription>
        <div class="subscription-banner text-center mb-8">
          <p class="text-gray-600">
            Vous n'avez pas d'abonnement actif. <a routerLink="/app/user/subscriptions" class="text-primary-purple underline hover:text-dark-purple">Souscrire maintenant</a>
          </p>
        </div>
      </ng-template>

      <!-- Progress Bar -->
      <div class="mb-12">
        <div class="flex items-center mb-4">
          <div class="flex items-center">
            <div class="step-indicator" [ngClass]="{ 'active': currentStep >= 1, 'border-gray-300 text-gray-400': currentStep < 1 }">
              <div class="flex items-center justify-center">
                <i *ngIf="currentStep > 1" class="ri-check-line"></i>
                <span *ngIf="currentStep <= 1">1</span>
              </div>
            </div>
            <span class="ml-2 text-sm font-medium text-gray-700">
              <i class="ri-star-line mr-1 text-primary-purple"></i> Choix du plan
            </span>
          </div>
          <div class="flex-1 mx-4">
            <div class="progress-bar">
              <div class="progress-fill" [style.width]="currentStep >= 2 ? '50%' : '0%'"></div>
            </div>
          </div>
          <div class="flex items-center">
            <div class="step-indicator" [ngClass]="{ 'active': currentStep >= 2, 'border-gray-300 text-gray-400': currentStep < 2 }">
              <div class="flex items-center justify-center">
                <i *ngIf="currentStep > 2" class="ri-check-line"></i>
                <span *ngIf="currentStep <= 2">2</span>
              </div>
            </div>
            <span class="ml-2 text-sm font-medium text-gray-700">
              <i class="ri-file-list-line mr-1 text-primary-purple"></i> Détails
            </span>
          </div>
          <div class="flex-1 mx-4">
            <div class="progress-bar">
              <div class="progress-fill" [style.width]="currentStep >= 3 ? '100%' : '0%'"></div>
            </div>
          </div>
          <div class="flex items-center">
            <div class="step-indicator" [ngClass]="{ 'active': currentStep >= 3, 'border-gray-300 text-gray-400': currentStep < 3 }">
              <span>3</span>
            </div>
            <span class="ml-2 text-sm font-medium text-gray-700">
              <i class="ri-shield-check-line mr-1 text-primary-purple"></i> Confirmation
            </span>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="error-message mb-6">
        <i class="ri-error-warning-line mr-2"></i>
        <span [innerHTML]="errorMessage"></span>
      </div>

     <!-- Step 1: Plan Selection -->
<!-- Step 1: Plan Selection -->
<div class="mb-12" *ngIf="currentStep === 1">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-dark font-display">Choix du forfait</h2>
    <div class="flex items-center">
      <span class="text-sm text-gray-600 mr-2">Mensuel</span>
      <label class="switch">
        <input type="checkbox" [checked]="billingType.value === 'annual'" (change)="toggleBillingType()" [disabled]="hasActiveSubscription" />
        <span class="slider rounded-full"></span>
      </label>
      <span class="text-sm text-gray-600 ml-2">Annuel</span>
      <span class="ml-2 text-xs bg-gold-100 text-gold-800 px-2 py-1 rounded-full">-20%</span>
    </div>
  </div>

  <!-- Active Subscription Message at the Top -->
  <div *ngIf="hasActiveSubscription" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <i class="ri-error-warning-line text-red-500 text-2xl mr-3"></i>
      <div>
        <p class="text-red-700 font-medium">
          Vous avez déjà un abonnement actif. Un seul abonnement est autorisé à la fois. Votre abonnement actuel : {{ activeSubscription?.subscriptionType }} ({{ activeSubscription?.billingCycle === 'monthly' ? 'Mensuel' : 'Annuel' }})
        </p>
        <p class="text-gray-600 text-sm mt-1">
          Consultez les détails dans votre <a routerLink="/app/user/profile" class="text-primary underline">profil</a>.
        </p>
      </div>
    </div>
  </div>

  <!-- Plan Cards -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div *ngFor="let plan of plans.value" class="plan-card bg-white rounded-lg border overflow-hidden"
         [ngClass]="{
           'border-primary': selectedPlan.value === plan.id && !hasActiveSubscription,
           'popular-plan': plan.isPopular,
           'shadow-sm': !plan.isPopular,
           'shadow-md': plan.isPopular,
           'opacity-50 cursor-not-allowed': hasActiveSubscription
         }"
         (click)="!hasActiveSubscription && selectPlan(plan.id)">
      <div class="p-6">
        <h3 class="text-xl font-semibold text-dark mb-2 font-display">{{ plan.name }}</h3>
        <div class="flex items-end mb-4">
          <span class="text-3xl font-bold text-dark">{{ calculatePrice(plan.monthlyPrice) }} TND</span>
          <span class="text-gray-600 ml-1">/{{ billingType.value === 'annual' ? 'an' : 'mois' }}</span>
        </div>
        <ul class="space-y-3 mb-6">
          <li *ngFor="let feature of plan.features" class="flex items-start">
            <div class="feature-icon w-6 h-6 flex items-center justify-center text-primary mr-2 mt-0.5">
              <i class="ri-check-line"></i>
            </div>
            <span class="text-gray-600">{{ feature }}</span>
          </li>
          <li *ngFor="let excluded of plan.excludedFeatures" class="flex items-center">
            <div class="flex-wrapper text-red-500 mr-2 mt-0.5">
              <i class="fi fi-rr-cross-circle"></i>
            </div>
            <span class="text-sm text-gray-400">{{ excluded }}</span>
          </li>
        </ul>
        <button class="w-full text-nowrap font-medium py-2 rounded-lg transition-colors"
                [class.btn-primary]="selectedPlan.value === plan.id && !hasActiveSubscription"
                [class.border-primary]="selectedPlan.value !== plan.id || hasActiveSubscription"
                [class.text-primary]="selectedPlan.value !== plan.id || hasActiveSubscription"
                [class.bg-white]="selectedPlan.value !== plan.id || hasActiveSubscription"
                [class.hover:bg-gray-50]="selectedPlan.value !== plan.id && !hasActiveSubscription"
                [disabled]="hasActiveSubscription">
          {{ selectedPlan.value === plan.id && !hasActiveSubscription ? 'Sélectionné' : 'Choisir ce forfait' }}
        </button>
      </div>
    </div>
  </div>


 

  <div class="mt-8 flex justify-between">
    <button type="button" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium" (click)="reset()">
      <i class="ri-refresh-line mr-2"></i> Réinitialiser
    </button>
    <button 
      type="button" 
      class="btn-primary px-6 py-3 rounded-lg font-medium flex items-center" 
      (click)="nextStep()"
      [disabled]="vehicles.value.length === 0 || !selectedPlan.value || hasActiveSubscription"
      matTooltip="Ajoutez un véhicule dans votre profil, sélectionnez un forfait ou vérifiez votre abonnement actif pour continuer"
      [matTooltipDisabled]="vehicles.value.length > 0 && !!selectedPlan.value && !hasActiveSubscription">
      Suivant <i class="ri-arrow-right-line ml-2"></i>
    </button>
  </div>
  <div *ngIf="vehicles.value.length === 0" class="text-red-500 text-sm mt-2">
    Veuillez ajouter un véhicule dans votre profil avant de continuer.
    <a routerLink="/profile" class="text-primary underline">Aller au profil</a>.
  </div>
</div>

      <!-- Step 2: Payment Details -->
      <div *ngIf="currentStep === 2 && !hasActiveSubscription" class="mb-12">
        <h2 class="text-2xl font-semibold text-dark mb-6 font-display">Détails de confirmation</h2>
        <div class="form-container">
          <form [formGroup]="subscriptionForm" (ngSubmit)="nextStep()">
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <div class="relative">
                  <input id="email" formControlName="email" type="email" class="input-field" placeholder="votre@email.com">
                  <i class="input-icon ri-mail-line"></i>
                </div>
                <div *ngIf="subscriptionForm.get('email')?.touched && subscriptionForm.get('email')?.invalid" class="text-red-200 text-xs mt-1">
                  <span *ngIf="subscriptionForm.get('email')?.hasError('required')">Email requis</span>
                  <span *ngIf="subscriptionForm.get('email')?.hasError('pattern')">Email invalide</span>
                </div>
              </div>
              <div>
                <label for="cardName" class="block text-sm font-medium text-gray-700 mb-1">Nom sur la carte</label>
                <div class="relative">
                  <input id="cardName" formControlName="cardName" type="text" class="input-field" placeholder="Ex: Jean Dupont">
                  <i class="input-icon ri-user-line"></i>
                </div>
                <div *ngIf="subscriptionForm.get('cardName')?.touched && subscriptionForm.get('cardName')?.hasError('required')" class="text-red-200 text-xs mt-1">Nom requis</div>
              </div>
              <div>
                <label for="cardNumber" class="block text-sm font-medium text-gray-700 mb-1">Numéro de carte</label>
                <div class="relative">
                  <input id="cardNumber" formControlName="cardNumber" mask="0000 0000 0000 0000" [showMaskTyped]="true" class="input-field" placeholder="XXXX XXXX XXXX XXXX">
                  <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex gap-2">
                    <i class="ri-visa-line text-xl text-blue-600"></i>
                    <i class="ri-mastercard-line text-xl text-orange-500"></i>
                  </div>
                </div>
                <div *ngIf="subscriptionForm.get('cardNumber')?.touched && subscriptionForm.get('cardNumber')?.invalid" class="text-red-200 text-xs mt-1">
                  <span *ngIf="subscriptionForm.get('cardNumber')?.hasError('required')">Numéro requis</span>
                  <span *ngIf="subscriptionForm.get('cardNumber')?.hasError('pattern')">Doit être 16 chiffres</span>
                </div>
              </div>
              <div>
                <label for="cardExpiry" class="block text-sm font-medium text-gray-700 mb-1">Date d'expiration</label>
                <div class="relative">
                  <input id="cardExpiry" formControlName="cardExpiry" type="text" mask="00/0000" [showMaskTyped]="true" [dropSpecialCharacters]="false" (input)="normalizeExpiry($event)" class="input-field" placeholder="MM/AAAA">
                  <i class="input-icon ri-calendar-line"></i>
                </div>
                <div *ngIf="subscriptionForm.get('cardExpiry')?.touched && subscriptionForm.get('cardExpiry')?.invalid" class="text-red-200 text-xs mt-1">
                  <span *ngIf="subscriptionForm.get('cardExpiry')?.hasError('required')">Date requise</span>
                  <span *ngIf="subscriptionForm.get('cardExpiry')?.hasError('invalidFormat')">Format invalide, ex: 07/2029</span>
                  <span *ngIf="subscriptionForm.get('cardExpiry')?.hasError('expired')">Carte expirée</span>
                </div>
              </div>
              <div>
                <label for="cardCvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                <div class="relative">
                  <input id="cardCvv" formControlName="cardCvv" type="text" mask="000" [showMaskTyped]="true" class="input-field" placeholder="123">
                  <i class="input-icon ri-question-line cursor-pointer" matTooltip="3 chiffres au dos de la carte"></i>
                </div>
                <div *ngIf="subscriptionForm.get('cardCvv')?.touched && subscriptionForm.get('cardCvv')?.invalid" class="text-red-200 text-xs mt-1">
                  <span *ngIf="subscriptionForm.get('cardCvv')?.hasError('required')">CVV requis</span>
                  <span *ngIf="subscriptionForm.get('cardCvv')?.hasError('pattern')">Doit être 3 chiffres</span>
                </div>
              </div>
            </div>
            <div class="mt-6">
              <p class="text-gray-600 text-sm">Montant: {{ getSelectedPlanPrice() }} TND / {{ billingType.value }}</p>
            </div>
            <div class="mt-8 flex justify-between">
              <button type="button" class="btn-secondary px-6 py-3 rounded-md font-medium flex items-center" (click)="prevStep()">
                <i class="ri-arrow-left-line mr-2"></i> Retour
              </button>
              <button type="submit" class="btn-primary px-6 py-3 rounded-md font-medium flex items-center" [disabled]="isLoading || !subscriptionForm.valid">
                <span *ngIf="!isLoading">Payer <i class="ri-arrow-right-line ml-2"></i></span>
                <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Step 3: Confirmation -->
<div *ngIf="currentStep === 3 && !hasActiveSubscription" class="mb-12">
  <h2 class="text-2xl font-semibold text-dark mb-6 font-display">Confirmation</h2>
  <div class="form-container">
    <!-- Success Message and Details -->
    <div *ngIf="subscriptionConfirmed" class="text-center">
      <i class="ri-verified-badge-line text-green-500 text-4xl mb-4"></i>
      <h3 class="text-2xl font-semibold text-dark mb-2">Abonnement Confirmé avec Succès !</h3>
      <p class="text-gray-600 mb-4">Merci pour votre souscription. Voici les détails de votre abonnement :</p>
      <div class="bg-gray-100 p-4 rounded-lg mb-4">
        <p><strong>ID Abonnement :</strong> {{ activeSubscription?.id }}</p>
        <p><strong>Type :</strong> {{ activeSubscription?.subscriptionType }}</p>
        <p><strong>Cycle de Facturation :</strong> {{ activeSubscription?.billingCycle }}</p>
        <p><strong>Date de Début :</strong> {{ activeSubscription?.startDate | date:'MM/dd/yyyy' }}</p>
        <p><strong>Date de Fin :</strong> {{ activeSubscription?.endDate | date:'MM/dd/yyyy' }}</p>
        <p><strong>Places Restantes :</strong> {{ activeSubscription?.remainingPlaces }}</p>
      </div>
      <button type="button" class="btn-primary px-6 py-3 rounded-md font-medium flex items-center" (click)="reset()">
        Retour à l'accueil <i class="ri-home-line ml-2"></i>
      </button>
    </div>

    <!-- Verification Form -->
    <form *ngIf="!subscriptionConfirmed" [formGroup]="subscriptionForm" (ngSubmit)="confirmSubscription()">
      <p class="text-gray-600 text-sm mb-4">
        Un code de confirmation a été envoyé à {{ subscriptionForm.get('email')?.value || 'votre email' }}.
      </p>
      <div class="mb-4">
        <label for="subscriptionConfirmationCode" class="block text-sm font-medium text-gray-700 mb-1">Code de Confirmation</label>
        <div class="relative">
          <input id="subscriptionConfirmationCode" formControlName="subscriptionConfirmationCode" type="text" class="input-field" placeholder="Entrez le code">
          <i class="input-icon ri-shield-check-line"></i>
        </div>
        <div *ngIf="subscriptionForm.get('subscriptionConfirmationCode')?.touched && subscriptionForm.get('subscriptionConfirmationCode')?.hasError('required')" class="text-red-200 text-xs mt-1">Code requis</div>
      </div>
      <div class="mt-8 flex justify-between">
        <button type="button" class="btn-secondary px-6 py-3 rounded-md font-medium flex items-center" (click)="prevStep()">
          <i class="ri-arrow-left-line mr-2"></i> Retour
        </button>
        <button type="submit" class="btn-primary px-6 py-3 rounded-md font-medium flex items-center" [disabled]="isLoading || !subscriptionForm.get('subscriptionConfirmationCode')?.valid">
          <span *ngIf="!isLoading">Confirmer <i class="ri-check-line ml-2"></i></span>
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
        </button>
      </div>
    </form>
  </div>
</div>
    </div>
  </main>
</div>